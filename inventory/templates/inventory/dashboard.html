{% extends 'inventory/base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- Szybkie akcje / Wykres -->
    <div class="row mb-4">
        <!-- Szybkie akcje -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-primary-custom">Akcje</div>
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <a href="{% url 'add_item' %}" class="btn btn-primary-custom mb-2 w-75">Dodaj Produkt</a>
                    <a href="{% url 'add_supplier' %}" class="btn btn-primary-custom mb-2 w-75">Dodaj Dostawcę</a>
                    <a href="{% url 'add_stock' %}" class="btn btn-primary-custom mb-2 w-75">Dodaj Stan Magazynowy</a>
                    <a href="{% url 'add_order' %}" class="btn btn-primary-custom mb-2 w-75">Dodaj Zamówienie</a>
                </div>
            </div>
        </div>

        <!-- Wykres zamówień według statusów -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-success-custom ">Zamówienia</div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <!-- Zmieniono wymiary płótna -->
                    <canvas id="orderStatusChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista braków (Towary wymagające uzupełnienia) -->
    <div class="card mb-4">
        <div class="card-header bg-info-custom d-flex justify-content-between align-items-center">
            <span>Rozbieżności</span>
            <!-- Filtr magazynu -->
            <form method="GET" action="{% url 'dashboard' %}">
                <label for="warehouse" class="form-label">Wybierz magazyn:</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-building"></i>
                    </span>
                    <select name="warehouse" id="warehouse" class="form-select" onchange="this.form.submit()">
                        <option value="" {% if not selected_warehouse_id %}selected{% endif %}>Wszystkie magazyny</option>
                        {% for warehouse in warehouses %}
                            <option value="{{ warehouse.whs_id }}" {% if warehouse.whs_id == selected_warehouse_id|default:'' %}selected{% endif %}>
                                {{ warehouse.whs_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
        <div class="card-body scrollable-table">
            <table class="table table-striped table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>NAZWA TOWARU</th>
                        <th>MAGAZYN</th>
                        <th>AKTUALNA ILOŚĆ</th>
                        <th>MINIMALNA ILOŚĆ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in dashboard_data %}
                        <tr>
                            <td data-label="NAZWA TOWARU">{{ row.item_name }}</td>
                            <td data-label="MAGAZYN">{{ row.warehouse_name }}</td>
                            <td data-label="AKTUALNA ILOŚĆ">{{ row.actual_qty }}</td>
                            <td data-label="MINIMALNA ILOŚĆ">{{ row.min_qty }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">Brak danych do wyświetlenia.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('orderStatusChart').getContext('2d');
    var orderStatusChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [{% for status in order_statuses %}"{{ status.ord_statusid__sta_name }}",{% endfor %}],
            datasets: [{
                label: 'Podział zamówień',
                data: [{% for status in order_statuses %}{{ status.count }},{% endfor %}],
                backgroundColor: [
                    '#00897B',  // Zielony
                    '#26A69A',  // Jasny Zielony
                    '#80CBC4',  // Pastelowy Zielony
                    '#004D40',  // Ciemny Zielony
                    '#FFB74D'   // Pomarańczowy
                ],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Umożliwia ręczne skalowanie
            layout: {
                padding: 10 // Dodaje margines wokół wykresu
            }
        }
    });
</script>
{% endblock %}
